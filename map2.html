<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>COVID-19 Cases in the United States (2020)</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />

  <link href="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.css" rel="stylesheet" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.8.1/mapbox-gl.js"></script>

  <!-- Google font (Open Sans) -->
  <link href="https://fonts.googleapis.com/css2?family=Open+Sans&display=swap" rel="stylesheet">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
    }

    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
    }

    /* Title */
    #title {
      position: absolute;
      top: 0;
      left: 0;
      margin-top: 18px;
      margin-left: 18px;
      font-size: 22pt;
      color: #111;
      background: rgba(255,255,255,0.85);
      padding: 10px 12px;
      border-radius: 6px;
    }

    #subtitle {
      position: absolute;
      top: 0;
      left: 0;
      margin-top: 72px;
      margin-left: 18px;
      font-size: 12pt;
      color: #111;
      background: rgba(255,255,255,0.85);
      padding: 6px 10px;
      border-radius: 6px;
    }

    /* Legend */
    #legend {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 210px;
      background: rgba(255,255,255,0.95);
      margin-right: 18px;
      margin-bottom: 18px;
      padding: 10px 12px;
      border-radius: 6px;
      font-size: 11pt;
      color: #111;
    }

    .legend-row {
      display: flex;
      align-items: center;
      margin: 8px 0;
      gap: 10px;
    }

    .dot {
      border-radius: 50%;
      display: inline-block;
      opacity: 0.65;
      border: 1px solid rgba(0,0,0,0.25);
      flex: 0 0 auto;
    }

    a { color: #111; }
  </style>
</head>

<body>
  <div id="map"></div>

  <div id="title">COVID-19 Cases</div>
  <div id="subtitle">U.S. Counties â€” 2020 (proportional symbols)</div>

  <div id="legend"></div>

  <script>
    mapboxgl.accessToken = 'pk.eyJ1IjoidmFtaWthZyIsImEiOiJjbWt6MHV3YjEwMmdyM3FxMGZzNzlob3lvIn0.9ml0_x6-glv7a9AdaYc3QA';

    const map = new mapboxgl.Map({
      container: 'map',
      style: 'mapbox://styles/mapbox/light-v10',
      center: [-98, 38],
      zoom: 3,
      minZoom: 2
    });

    
    map.setProjection('albers');

    // FIELD NAMES 
    const CASES_FIELD = 'cases';
    const COUNTY_FIELD = 'county';
    const STATE_FIELD = 'state';
    const DEATHS_FIELD = 'deaths';

    // Breaks for proportional symbols (cases)
    const breaks = [1000, 10000, 50000, 100000];
    const radii  = [3, 7, 14, 22];

    function buildLegend() {
      const legend = document.getElementById('legend');
      const rows = [];
      rows.push(`<div style="font-weight:700; margin-bottom:6px;">Legend (cases)</div>`);

      for (let i = 0; i < breaks.length; i++) {
        const label = breaks[i].toLocaleString();
        const size = radii[i] * 2;

        rows.push(`
          <div class="legend-row">
            <span class="dot" style="width:${size}px; height:${size}px; background: rgba(33,113,181,1);"></span>
            <div>${label}</div>
          </div>
        `);
      }

      rows.push(`<div style="font-size:10pt; margin-top:8px; text-align:right;">
        Sources: <a href="https://www.nytimes.com/interactive/2021/us/covid-cases.html" target="_blank">NYT</a>,
        <a href="https://www.census.gov/programs-surveys/acs" target="_blank">ACS</a>,
        <a href="https://www.census.gov/geographies/mapping-files/time-series/geo/carto-boundary-file.html" target="_blank">U.S. Census</a>
      </div>`);

      legend.innerHTML = rows.join('');
    }

    map.on('load', () => {
      map.addSource('counts', {
        type: 'geojson',
        data: 'assets/us-covid-2020-counts.json'
      });

      // Proportional circle layer (should be on top)
      map.addLayer({
        id: 'covid-counts-circles',
        type: 'circle',
        source: 'counts',
        paint: {
          'circle-radius': [
            'interpolate',
            ['linear'],
            ['coalesce', ['to-number', ['get', CASES_FIELD]], 0],
            breaks[0], radii[0],
            breaks[1], radii[1],
            breaks[2], radii[2],
            breaks[3], radii[3]
          ],
          'circle-color': 'rgba(33,113,181,1)',
          'circle-opacity': 0.6,
          'circle-stroke-color': 'white',
          'circle-stroke-width': 1
        }
      });

      buildLegend();

      // Interactive popup
      map.on('click', 'covid-counts-circles', (e) => {
        const p = e.features[0].properties;

        const casesVal = Number(p[CASES_FIELD]);
        const deathsVal = Number(p[DEATHS_FIELD]);

        new mapboxgl.Popup()
          .setLngLat(e.lngLat)
          .setHTML(`
            <strong>${p[COUNTY_FIELD]}, ${p[STATE_FIELD]}</strong><br/>
            Cases: ${Number.isFinite(casesVal) ? casesVal.toLocaleString() : 'N/A'}<br/>
            Deaths: ${Number.isFinite(deathsVal) ? deathsVal.toLocaleString() : 'N/A'}
          `)
          .addTo(map);
      });

      map.on('mouseenter', 'covid-counts-circles', () => {
        map.getCanvas().style.cursor = 'pointer';
      });

      map.on('mouseleave', 'covid-counts-circles', () => {
        map.getCanvas().style.cursor = '';
      });
    });
  </script>
</body>

</html>
